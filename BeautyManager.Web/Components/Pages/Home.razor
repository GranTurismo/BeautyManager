@page "/"
@using System.Collections.Immutable
@using System.Timers
@using BeautyManager.Shared
@using BeautyManager.Shared.Connection
@using BeautyManager.Shared.Models.Db
@using BeautyManager.Shared.Models.Local
@using BeautyManager.Web.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.IdentityModel.Tokens
@inject BeautyDbContext DbCon;
@inject IJSRuntime JsRuntime;
@inject ErrorMessage ErrorMessage;

@if (_isPageLoading)
{
    <div class="d-flex justify-content-center align-items-center loading-overlay py-5">
        <div class="text-center loading-card rounded-4 p-4 shadow-lg">
            <div class="mb-3 d-flex justify-content-center">
                <div class="rounded-circle p-3 shadow-sm" style="background:linear-gradient(135deg,#fff,#f3f9ff);">
                    <div class="spinner-border text-primary" role="status" style="width:3.2rem; height:3.2rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <h4 class="fw-bold text-primary mb-1" style="letter-spacing:0.6px;">Loading your beauty experience</h4>
            <p class="text-muted small mb-3">Preparing stylists, slots and service details…</p>
            <div class="d-flex gap-2 justify-content-center">
                <div class="skeleton rounded-pill"></div>
                <div class="skeleton rounded-pill" style="width:100px;"></div>
                <div class="skeleton rounded-pill" style="width:80px;"></div>
            </div>
        </div>
    </div>
    return;
}

<PopupInfo CancellationCode="@currentBookCancellationCode" Title="Only way to cancel it"></PopupInfo>
<CancellationModal @bind-Show="@_isCancellationShown" Title="Cancellation" OnSubmit="@OnCancelSubmit"></CancellationModal>
<BookingModal BeautyTasks="_beautyTasks" OnBooking="@Book" SelectedCard="_selectedCard"
              @bind-IsShown="@_isBookingModalShown"></BookingModal>

<div class="container py-5">
    <div class="home-header">
        <div class="logo"><i class="bi bi-stars"></i></div>
        <div>
            <h1 class="fw-bold text-primary mb-0" style="letter-spacing:1px;">Beauty Manager</h1>
            <div class="text-secondary small">Book your beauty session with ease</div>
        </div>
    </div>
    <div class="mb-4">
        <label for="stylistSelect" class="form-label fw-semibold text-primary">
            <i class="bi bi-scissors me-2"></i> Choose Stylist
        </label>
        <InputSelect id="stylistSelect"
                     class="form-select form-select-lg rounded-pill shadow-sm border-primary"
                     @bind-Value="SelectedStylistId">
            <option disabled value="">-- Select a Stylist --</option>
            @foreach (Stylist stylist in _stylists)
            {
                <option value="@stylist.Id">@stylist.Name</option>
            }
        </InputSelect>
    </div>

    <h2 class="mb-4 fw-bold text-primary">Today's Working Cards</h2>
    <div class="day-nav-group">
        <button @onclick="() => Next(-1)"
                class="btn btn-outline-primary rounded-pill px-4 py-2 shadow-sm d-flex align-items-center gap-2">
            <i class="bi bi-arrow-left-circle fs-5"></i>
            Prev Day
        </button>
        <button @onclick="() => Next(1)"
                class="btn btn-primary rounded-pill px-4 py-2 shadow-sm d-flex align-items-center gap-2">
            Next Day
            <i class="bi bi-arrow-right-circle fs-5"></i>
        </button>
    </div>
    <div class="row g-4 justify-content-center">
        @if (_workingCards.Count > 0)
        {
            @foreach (WorkingCard card in _workingCards)
            {
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">

                    <div
                        class="card working-card h-100 @(card.IsBooked ? "booked" : "") @(card.IsPassed ? "passed" : "")"
                        @onclick="@(() => OnCardClick(card))">
                        <div class="card-body d-flex flex-column justify-content-between position-relative">
                            @if (card.IsBooked && !card.IsPassed)
                            {
                                <button class="btn cancel-btn shadow"
                                        title="Cancel booking"
                                        @onclick:stopPropagation
                                        @onclick="() => CancelBookingAsync(card)">
                                    <i class="bi bi-x-circle-fill me-1"></i>Cancel
                                </button>
                            }

                            <h5 class="card-title text-secondary mb-2">@card.StartDate.ToString("MMMM dd, yyyy")</h5>
                            <p class="card-text fs-5 mb-1">
                                <span class="badge bg-primary">@card.StartDate.ToString("hh:mm")</span>
                            </p>
                            @if (card.IsBooked || card.IsPassed)
                            {
                                <p class="card-text mt-2 mb-0 small text-danger">
                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                    <span class="fw-semibold">@(card.IsPassed ? "Passed" : "Booked")</span>
                                </p>
                            }
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-info">No working cards found for today.</div>
            </div>
        }
    </div>
</div>

@code{
    private string? InputNumber { get; set; } = string.Empty;
    private string? _customerName = string.Empty;
    private int _selectedTaskId;
    private Stylist? _selectedStylist;
    private bool _isBooking = false;
    private bool _isPageLoading = true;
    private int currentBookCancellationCode;

    private int SelectedStylistId
    {
        get;
        set
        {
            field = value;
            _selectedStylist = _stylists.FirstOrDefault(o => o.Id == SelectedStylistId);
            if (_selectedStylist != null)
            {
                UpdateBooks();
                UpdateWorkingCards();
                UpdateBeautyTasks();
                DisableBookedCards();
            }
        }
    }

    private bool _isCancellationShown;

    private List<Stylist> _stylists = new();
    private List<BeautyBook> _books = new();
    private WorkingCard? _selectedCard;
    List<BeautyTask> _beautyTasks = new();

    DateTime _startDate = new(DateTime.Now.Year, DateTime.Now.Month,
        DateTime.Now.Day, Constants.OpeningTime.Hour, Constants.OpeningTime.Minute, 0);

    ImmutableList<WorkingCard> _workingCards = ImmutableList<WorkingCard>.Empty;
    private bool _isBookingModalShown = false;

    private void UpdateBeautyTasks()
    {
        if (_selectedStylist == null) return;
        _beautyTasks = _selectedStylist.BeautyTaskStylists
            .Select(o => o.BeautyTask)
            .ToList();
        if (_beautyTasks.Any())
            _selectedTaskId = _beautyTasks.First().Id;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (!firstRender)
            return;

        _stylists = await GetStylists();
        if (_stylists.Any())
            SelectedStylistId = _stylists.First().Id;
        _isPageLoading = false;
        StateHasChanged();
    }

    private async Task<List<Stylist>> GetStylists()
    {
        return await DbCon.Stylists
            .Include(o => o.BeautyTaskStylists).ThenInclude(o => o.BeautyTask)
            .Include(o => o.Books).ToListAsync();
    }

    private void UpdateWorkingCards()
    {
        _workingCards = WorkingCard.GetCardsForDay(_startDate).ToImmutableList();
        if (_workingCards.Any())
            _selectedCard = _workingCards.First();
    }

    private void UpdateBooks()
    {
        if (_selectedStylist != null)
            _books = _selectedStylist.Books.ToList();
    }

    private void DisableBookedCards()
    {
        foreach (BeautyBook book in _books)
        {
            DateTimeOffset bookEndDate = book.ExecutingDate.Add(book.Task.TaskDuration.ToTimeSpan());
            ImmutableList<WorkingCard> affectedCards = _workingCards.Where(o => book.ExecutingDate <= o.StartDate && bookEndDate > o.StartDate).ToImmutableList();
            foreach (WorkingCard card in affectedCards)
            {
                card.IsBooked = true;
            }
        }
    }

    private void OnCardClick(WorkingCard card)
    {
        bool isBlocked = card.IsBooked || card.IsPassed;
        if (isBlocked)
            return;
        _selectedCard = card;
        _isBookingModalShown = true;
    }

    private async Task Book(BeautyBook book)
    {
        currentBookCancellationCode = book.CancellationCode;
        _selectedStylist?.Books.Add(book);
        await DbCon.SaveChangesAsync();
        UpdateWorkingCards();
        UpdateBooks();
        DisableBookedCards();
        _isBookingModalShown = false;
    }

    private void Next(int daysCount)
    {
        _startDate = _startDate.AddDays(daysCount);
        UpdateWorkingCards();
        DisableBookedCards();
    }

    private Task CancelBookingAsync(WorkingCard card)
    {
        _isCancellationShown = true;
        return Task.CompletedTask;
    }

    private Task OnCancelSubmit(string code)
    {
        Console.WriteLine(code);

        return Task.CompletedTask;
    }

}

